<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Whack A Mole!</title>
  <link href='https://fonts.googleapis.com/css?family=Amatic+SC:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>Whack-a-mole! <span class="score">0</span></h1>
  <div><button onClick="startGame()" id="start">Start Game!</button></div>
  
  <div class="game">
    <div class="hole hole1">
      <div class="mole"></div>
    </div>
    <div class="hole hole2">
      <div class="mole"></div>
    </div>
    <div class="hole hole3">
      <div class="mole"></div>
    </div>
    <div class="hole hole4">
      <div class="mole"></div>
    </div>
    <div class="hole hole5">
      <div class="mole"></div>
    </div>
    <div class="hole hole6">
      <div class="mole"></div>
    </div>
    <div class="hole hole7">
      <div class="mole"></div>
    </div>
    <div class="hole hole8">
      <div class="mole"></div>
    </div>
    <div class="hole hole9">
      <div class="mole"></div>
    </div>
  </div>
  
  <div class="gameend">
    <div class="gameover">
      <span onclick="closeModal()">[close]</span>
      <h1>Game Over!</h1>
      <div class="leaderboard">
      <span>Top 3 scores</span>
        <ol class="highscores">
<!--
          <li></li>
          <li></li>
          <li></li>
-->
        </ol>
      </div>
    </div>
  </div>
  

<script>
  const holes = document.querySelectorAll('.hole'),
        scoreBoard = document.querySelector('.score'),
        moles = document.querySelectorAll('.mole'),
        gameendScreen = document.querySelector('.gameend'),
        highscoresList = document.querySelector('.highscores');
  let lastHole,
      timesUp = false,
      score = 0,
      duration = 10000;
  
  const closeModal = () => gameendScreen.style.display = 'none';
  
  const removeAllChildren = (parent) => {
    let child = parent.lastElementChild;
    while(child){
      parent.removeChild(child);
      child = parent.lastElementChild;
    }
  }
  
  const randomTime = (min = 200, max = 1000) => Math.round(Math.random() * (max - min) + min);
  
  const randomHole = (holes) => {
    const randomIndex = Math.floor(Math.random() * holes.length);
    const hole = holes[randomIndex];
    
    // ensure hole is not the same as the previous one
    if(hole === lastHole) return randomHole(holes);
    
    lastHole = hole;
    return hole;
  }
  const peep = () => {
    const peepTime = randomTime();
    const hole = randomHole(holes);
    
    hole.classList.add('up');
    setTimeout(() => {
      hole.classList.remove('up');
      if(!timesUp) peep();
    }, peepTime)
  }
  
  const saveHighScores = () => {
    const oldHighScores = JSON.parse(localStorage.getItem('scores')) || [];
    const newHighScores = oldHighScores.map(n => parseInt(n))
                                       .concat(score)
                                       .sort((a,b) => b - a)
                                       .filter((score, index, self) => self.indexOf(score) === index) // fiter for unique scores
                                       .slice(0, 3);
    localStorage.setItem('scores', JSON.stringify(newHighScores));
    return newHighScores;
  }
  
  const showEndGameScreen = () => {
    const highScores = saveHighScores();
    const fragment = highScores.reduce((fragment, score) => {
      const li = document.createElement('li');
      li.textContent = score;
      fragment.appendChild(li);
      return fragment;
    }, document.createDocumentFragment());
    
    removeAllChildren(highscoresList);
    highscoresList.appendChild(fragment);
    
    gameendScreen.style.display = 'flex';
  }
  
  const startGame = () => {
    timesUp = false;
    score = 0;
    scoreBoard.textContent = score;
    peep();
    setTimeout(() => {
      timesUp = true;
      setTimeout(showEndGameScreen, 1500);
    }, duration)
  }
  
  const updateScore = (e) => {
    if(e.isTrusted) {
      score++;
      scoreBoard.textContent = score;
    }
  }
  
  moles.forEach(mole => mole.addEventListener('click', updateScore));

</script>
</body>
</html>
